[Home - AD163](/README.md#exercises)

# Exercise 3: Implement transactional behavior in ADT, create validations and determinations

## Introduction

In this exercise, you will add transactional behavior to the read-only service that has been generated based on the CSN-model that has been created in SAP Business Application Studio using the graphical modeler.

For this we have to create and maintain the following objects:  
- Behavior Definition
- Behavior Projection 

> **Outlook - Roadmap**   
> It is planned that the above mentioned objects will generated automatically generated by the wizard that is started from within SAP Business Application Studio in an upcoming release of SAP BTP ABAP Environment.  
> In the meantime we have to create and maintain the respective objects manually.   

In addition we will   
- add determination and a validation to the behavior definition  
- implement the determination and the validation in the behavior implementation class
- make some fields read-only since they will be determined by the above mentioned determinations

> For a more complete implementation of your RAP BO you will need to implement several determinations and validations. However due to time-constraints we will only implement one determination and one validations to show the concept. 
> The implementation of additional ABAP business logic is described in the optional Exercise 5.

### Exercise Steps

- [3.1 - Create an ABAP Cloud Project in ADT](#31---create-abap-cloud-project-in-adt)
- [3.2 - Test the generated read only rap business object](#32---test-the-generated-read-only-rap-business-object)
- [3.3 - Change the table definiton Z###CART](#33---change-the-table-definition-zcart)
- [3.4 - Change the CDS view ZR###_Cart](#34---change-the-cds-view-zr_cart)
- [3.5 - Change the metadata extensions z###c_cartprojection and z###c_itemprojection](#35---change-the-generated-metadata-extensions-zc_cartprojection-and-zc_itemprojection)
- [3.6 - Change the projection views z###c_cartprojection and z###c_itemprojection](#36---change-the-projection-views-zc_cartprojection-and-zc_itemprojection)
- [3.7 - Create a behavior definiton](#37---create-a-behavior-definition)
- [3.8 - Create a behavior projection](#38---create-a-behavior-projection)
- [3.9 - Test the transactional behavio of the RAP business object](#39-test-the-transactional-behavior-of-the-rap-business-object)
- [3.10 - Define derterminations](#310---define-determinations)
- [3.11 - Implement the determinations using Joule](#311---implement-the-determination-using-joule-)
- [3.12 - Define validations](#312---define-validations)
- [3.13 - Implement the validations using Joule](#313---implement-the-validations-using-joule-)
- [3.14 - Preview and test the enhanced online shop app](#314---preview-and-test-the-enhanced-online-shop-app)
- [Summary](#summary)
- [Next exercise](#summary--next-exercise)
- [Summary & Next Exercise](#summary--next-exercise)  


> ‚ÑπÔ∏è**Reminder:**   
> Don't forget to replace all occurences of the placeholder **`###`** with your suffix or Group ID in the exercise steps below.   
> You can use the ADT function **Replace All** (**Ctrl+F**) for this purpose. 


## 3.1 - Create ABAP cloud project in ADT

You will now create an ABAP Cloud project in ADT in order to enhance the generated code and to implement some business logic.   

You can do so directly from within Business Application Studio, or you can create the project manually from within ADT.

### 3.1.1 - Create an ABAP Cloud Project from within BAS

<details>
<summary>Click to expand</summary>

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Section 3.1.1. requires a hotfix from BAS
‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

1. Open SAP Build Lobby.  
   
   > The URL and the username and the password will be provided to you by the course instructors.   
   > The URL to the SAP Build Lobby is provided as a shortened URL in a format such as `https://url.sap/abc123`. 

2. Add the shortened URL for the SAP Build Lobby into your browser.

3. Open your **Full Stack ABAP Application** project `ZAD163_###` that you have created in the previous exercise, so that your Full Stack ABAP Application Project is opened in Business Application Studio again.

4. Open the File Explorer ![File Explorer](./images/bas_file_explorer.png) in Business Application Studio on the left hand side menu and select the entry for the Service Binding `Z###UI_CARTSERVICE_O4`.

   ![Start ADT](./images/20_000_select_service_binding_in_bas.png)   

5. Now click on the link called **Open this object in ADT** as shown in the following screen shot:
   
   ![Start ADT](./images/20_005_select_service_binding_in_bas.png)   
   
6. ADT will be opened and since no ABAP Cloud project has been created yet for this system (this SID) you have to press the button **New** in order to start the creation of a new ABAP Cloud project in ADT.   

   ![Start ADT](./images/20_010_new_empty_project.png) 

7. Select **ABAP Cloud Project** as the project type.   

   ![Start ADT](./images/20_020_new_empty_project.png) 

8. Copy the URL of the SAP BTP ABAP Environment System into the field **ABAP Service Instance URL** and click **Next >**.

   > The URL of the SAP BTP ABAP Environment will be provided to you by the course instructors.
   > The URL is provided as a shortened URL in a format such as `https://url.sap/abc123`.   
   > Copy the expanded URL from the browser into the field **ABAP Service Instance URL**.   

   ![Start ADT](./images/20_030_new_empty_project_add_url.png) 

8. Click **Open Logon Page in Browser**.

   ![Start ADT](./images/20_040_new_empty_project_authentication.png) 

9. Now you've been authenticated automatically. Provide your credentials if requested. The credentials are the same you used to logon to the SAP Build Lobby. 

   ![Start ADT](./images/20_070_open_service_binding.png) 

10. You can rename the project such that it includes your group id e.g.**H63_###**. 

    ![Start ADT](./images/20_050_new_empty_project_authentication.png) 
 
11. When being asked, open the associated (ABAP) perspective by clicking **Open Perspective** and check the check box **Remember my decsion**. 

    ![Start ADT](./images/20_060_new_empty_project_authentication.png)

12. This will finally open the Service Binding in ADT  

    ![Start ADT](./images/20_070_open_service_binding.png)

</details>



### 3.1.2 - Create an ABAP Cloud Project from within ADT

<details>
<summary>Click to expand</summary>

1. Open Eclipse. Make sure you have installed ADT in your Eclipse.   

   ![Start Eclipse](./images/eclipse.png)    

2. Select **File** > **New** > **Other** > **ABAP Cloud Project** and click **Next >**.

   ![Create ABAP cloud project](./images/cloud.png)

3. Copy the URL of the SAP BTP ABAP Environment System into the field **ABAP Service Instance URL** and click **Next >**.

   > The URL of the SAP BTP ABAP Environment will be provided to you by the course instructors.
   > The URL is provided as a shortened URL in a format such as `https://url.sap/abc123`    
   > Copy the shortened URL into your browser and copy **the expanded URL** from the browser into the field **ABAP Service Instance URL**.    

   ![Create ABAP cloud project](./images/00_120_new_abap_cloud_project.png)

4. Click **Open Logon Page in Browser**.

   ![Create ABAP cloud project](./images/project44.png)

5. Now you've been authenticated automatically. Provide your credentials if requested. The credentials are the same you used to logon to the SAP Build Lobby.   

   You can rename the project e.g. such that it includes your group id to `H63_EN_###`

   Go back to ADT.

   ![Create ABAP cloud project](./images/project52.png)

   Click **Finish**.


6. The SAP BTP ABAP Environment system `H63` appears on the project explorer.

7. Right click on the folder **Favorite Packages** and choose **Add Package** from the context menue.
  
   ![Create ABAP cloud project](./images/00_150_add_favorite_package.png) 

8. Enter the name `ZAD163_###` of your package and press **OK**.      

</details>

## 3.2 - Test the generated read-only RAP business object

Within the package `ZAD163_###` you will find the generated service binding `Z###UI_CARTSERVICE_O4`. Using the SAP Fiori Elements preview functionality a test UI is being provided without having to deploy the Fiori Elements App.

<details>
<summary>Click to expand</summary>

1. Open the generated service binding `Z###UI_CARTSERVICE_O4` using ADT.  

2. Double click on the leading entity `CartProjection` or select it and click on the **Preview** button.
  
   ![Open SAP Fiori Elements Preview](./images/00_200_test_service.png)

3. The UI will be shown, but no content is available. There is also no **Create** button available yet, that would allow you to create new entities.

   ![Open SAP Fiori Elements Preview](./images/00_210_test_service.png)

We will change this by adding **CRUD** capabilities to the generated read-only service.

> ‚ÑπÔ∏è It is planned to add the CRUD features in the generated service automatically in an upcoming release.

</details>  

## 3.3 - Change the table definition `Z###CART` 

We have to start with adding administrative fields that are required by the ABAP runtime to store the information when an object has been created, changed and by whom.  

<details>
<summary>Click to expand</summary>


Use the **Open ABAP Development Icon** ![](./images/ADT_open_object.png) in the toolbar or press `Ctrl+Shift+A` and enter `Z###CART` in the search dialogue to open the table edtior.  

1. You have to add the following administrative fields to the ![](./images/ADT_table.png) table `Z###CART`.

```ABAP 
  local_created_by        : abp_creation_user;
  local_created_at        : abp_creation_tstmpl;
  local_last_changed_by   : abp_locinst_lastchange_user;
  local_last_changed_at   : abp_locinst_lastchange_tstmpl;
  last_changed_at         : abp_lastchange_tstmpl;
```

2. Press ![](./images/ADT_save.png)  (Ctrl+S) and then ![](./images/ADT_activate.png) (Ctrl+5) to save and activate your changes.   

   So that the code of your table `Z###CART` should look like follows:  

```ABAP   
  @EndUserText.label : 'Z###CART'
  @AbapCatalog.enhancement.category : #NOT_EXTENSIBLE
  @AbapCatalog.tableCategory : #TRANSPARENT
  @AbapCatalog.deliveryClass : #A
  @AbapCatalog.dataMaintenance : #ALLOWED
  define table z###cart {

   key client              : abap.clnt not null;
   key order_uuid          : abap.raw(16) not null;
   currency                : abap.cuky;
   notes                   : abap.char(100);
   order_id                : abap.numc(8);
   requested_delivery_date : abap.dats;
   @Semantics.amount.currencyCode : 'z###cart.currency'
   total_price             : abap.curr(11,2);
   local_created_by        : abp_creation_user;
   local_created_at        : abp_creation_tstmpl;
   local_last_changed_by   : abp_locinst_lastchange_user;
   local_last_changed_at   : abp_locinst_lastchange_tstmpl;
   last_changed_at         : abp_lastchange_tstmpl;

 }
```



</details>

## 3.4 - Change the CDS view `Z###R_Cart`

The administrative fields that we have added to the table `Z###CART` have to be added to the `Cart` CDS-R-view as well.  

<details>
<summary>Click to expand</summary>

1. Use the **Open ABAP Development Icon** in the toolbar or press `Ctrl+Shift+A` and enter `Z###R_Cart` in the search dialogue to open the cds view editor.

   ![Open CDS view editor](./images/00_310_open_data_definition.png)

2. Add the following fields as additional fields before the association `_Items`    

```ABAP   
  local_created_by as LocalCreatedBy,
  @Semantics.systemDateTime.createdAt: true
  local_created_at as LocalCreatedAt,
  @Semantics.user.localInstanceLastChangedBy: true
  local_last_changed_by as LocalLastChangedBy,
  @Semantics.systemDateTime.localInstanceLastChangedAt: true
  local_last_changed_at as LocalLastChangedAt,
  @Semantics.systemDateTime.lastChangedAt: true
  last_changed_at as LastChangedAt,
``` 

   as shown in the following screen shot.

   ![add fields to r-view](./images/02_add_fields_to_r_view.png)   
   
   3. Save and activate your changes.

</details>

## 3.5 - Change the generated metadata extensions `Z###C_CartProjection` and `Z###C_ItemProjection`

In the generated meta data extensions we have to remove the field `Currency`. If this annotation is not being removed, the currency field will show up twice in the object page for the `Cart`and the `Item` entity.  

In addition the UUID based key fields should be marked with the annotation `@UI.hidden: true` so that the users cannot select them in the UI. 

> ‚ÑπÔ∏è The above mentioned behaviors are bugs that will be fixed in an upcoming hotfix collection or latest with the next upcoming release.  

<details>
<summary>Click to expand</summary>

### 3.5.1 - Change the metadata extension `Z###C_CartProjection`

```ABAP
//  @UI.fieldGroup: [ {
//    position: 10 , 
//    qualifier: 'GeneratedGroup'
//  } ]
//  @UI.lineItem: [ {
//    position: 10 , 
//    importance: #HIGH
//  } ]
//  Currency;  

  @UI.hidden: true
  OrderUuid;
```  

so that your coding now looks like   

![remove UI annotations for currency](./images/00_300_metadata_extensions.png)   

The complete final source code can be found here:  
<details>
<summary>Click to expand source code</summary>   

```ABAP
@Metadata.layer: #CORE
annotate view Z###C_CartProjection with
{
  @UI.facet: [ {
    id: 'GeneratedFacet1', 
    purpose: #STANDARD, 
    type: #FIELDGROUP_REFERENCE, 
    targetQualifier: 'GeneratedGroup', 
    position: 10 , 
    label: 'General Information'
  }, 
  {
    id: 'Items', 
    purpose: #STANDARD, 
    type: #LINEITEM_REFERENCE, 
    label: 'Items', 
    position: 20 , 
    targetElement: '_Items'
  } ]
//  @UI.fieldGroup: [ {
//    position: 10 , 
//    qualifier: 'GeneratedGroup'
//  } ]
//  @UI.lineItem: [ {
//    position: 10 , 
//    importance: #HIGH
//  } ]
//  Currency;  

  @UI.hidden: true
  OrderUuid;
  
  @UI.fieldGroup: [ {
    position: 20 , 
    qualifier: 'GeneratedGroup'
  } ]
  @UI.lineItem: [ {
    position: 20 , 
    importance: #HIGH
  } ]
  Notes;
  
  @UI.fieldGroup: [ {
    position: 30 , 
    qualifier: 'GeneratedGroup'
  } ]
  @UI.lineItem: [ {
    position: 30 , 
    importance: #HIGH
  } ]
  OrderID;
  
  @UI.fieldGroup: [ {
    position: 40 , 
    qualifier: 'GeneratedGroup'
  } ]
  @UI.lineItem: [ {
    position: 40 , 
    importance: #HIGH
  } ]
  RequestDeliveryDate;
  
  @UI.fieldGroup: [ {
    position: 50 , 
    qualifier: 'GeneratedGroup'
  } ]
  @UI.lineItem: [ {
    position: 50 , 
    importance: #HIGH
  } ]
  TotalPrice;
}
```
</details>

### 3.5.2 - Change the metadata extensions `Z###C_ItemProjection`

```ABAP
//  @UI.fieldGroup: [ {
//    position: 10 , 
//    qualifier: 'GeneratedGroup'
//  } ]
//  @UI.lineItem: [ {
//    position: 10 , 
//    importance: #HIGH
//  } ]
//  Currency; 

  @UI.hidden: true
  ItemUuid;
```  

so that your coding now looks like   

![remove UI annotations for currency](./images/00_310_metadata_extensions.png)   

</details>

## 3.6 - Change the projection views `Z###C_CartProjection` and `Z###C_ItemProjection`  

In the CDS projection view `Z###C_CartProjection` we have to publish the administrative fields that we have added to the CDS R-view layer .

<details>
<summary>Click to expand</summary>

### Change projection views `Z###C_CartProjection` (data definition)

Add the following entries to make the administrative fields accessible in our service. 

```ABAP 
  LocalCreatedBy,
  LocalCreatedAt,
  LocalLastChangedBy,
  LocalLastChangedAt,
  LastChangedAt,
```

so that your coding now looks like   

![publish administrative fields](./images/00_320_projection_view.png)

### Change projection view  `Z###C_ItemProjection` (data definition)

In the projection view `Z###C_ItemProjection` we add a value help for the field `OrderedItem`.

Just copy the following code

```ABAP 
  @Consumption.valueHelpDefinition: [ { entity: { name: 'ZAD163_I_PRODUCTS', element: 'Material' },
                                            useForValidation: true,
                                            additionalBinding: [ { localElement: 'ItemUnitPrice',
                                                                   element: 'Price',
                                                                   usage: #RESULT },
                                                                 { localElement: 'Currency',
                                                                   element: 'Currency',
                                                                   usage: #RESULT } ] } ]

  
```

just above the property `OrderedItem`  
so that your coding now looks like   

![add value help](./images/06_020_add_value_help.png)

</details>

## 3.7 - Create a behavior definition

Since the generator of the graphical modeller as of now does not generate the transactional behavior we have to create a behavior definiton and a behavior projection.

<details>
<summary>Click to expand</summary>

1. In your package `ZADT163_###` navigate to the folder **Data Definitions**, right click on the root view `ZR_CART_###` and select **New behavior definition** from the context menu.   

   ![create_bdef](./images/02_add_bdef_to_r_view.png)

2. In the **New Behavior Defintion** dialogue just press **Next**.

   ![create_bdef](./images/02_020_add_bdef_to_r_view.png)

3. In the **Select Transport Request** dialogue select your transport request that is required for packages in the software component **ZAD163_EXERCICES**.

   ![create_bdef](./images/02_030_select_transport.png)   


4. In the following we have to add several statements to enable the support for transactional behavior.  

5. Replace the code in the generated behavior definition with the code below.

   > We have provided a code snippet that contains all the changes so that you can replace the coding that is provided by the ADT wizard. A detailed description of the code changes is being provided in the following (optional) exercise.

6. Replace the placeholder `###` with your group id.

   ![replace_placeholder_in_bdef](./images/02_40_replace_placeholder_for_bdef.png)  

-----------------------

```
managed implementation in class Z###BP_R_CART unique;
strict ( 2 );
with draft;
extensible;
define behavior for Z###R_CART alias Cart
persistent table Z###CART
extensible
draft table Z###CART_D
etag master LocalLastChangedAt
lock master total etag LastChangedAt
authorization master( global )
{
  field ( readonly )
   OrderUuid,
   LocalCreatedBy,
   LocalCreatedAt,
   LocalLastChangedBy,
   LocalLastChangedAt,
   LastChangedAt;

  field ( numbering : managed )
   OrderUuid;


  create;
  update;
  delete;

  draft action Activate optimized;
  draft action Discard;
  draft action Edit;
  draft action Resume;
  draft determine action Prepare;

  mapping for Z###CART corresponding extensible
  {
    OrderUuid = order_uuid;
    Currency = currency;
    Notes = notes;
    OrderID = order_id;
    TotalPrice = total_price;
    RequestDeliveryDate = request_delivery_date;
    LocalCreatedBy = local_created_by;
    LocalCreatedAt = local_created_at;
    LocalLastChangedBy = local_last_changed_by;
    LocalLastChangedAt = local_last_changed_at;
    LastChangedAt = last_changed_at;
  }

  association _Items { create; with draft; }

}

define behavior for Z###R_ITEM alias Item
persistent table Z###ITEM
extensible
draft table Z###ITEM_D
etag dependent by _Parent
lock dependent by _Parent
authorization dependent by _Parent
{
  field ( readonly )
   ItemUuid,
   ParentUuid;

  field ( numbering : managed )
   itemUuid;


  update;
  delete;

  mapping for Z###ITEM corresponding extensible
  {
    itemUuid = item_uuid;
    ParentUuid = parent_uuid;
    Currency = currency;
    ItemID = item_id;
    ItemPrice = item_price;
    ItemUnitPrice = item_unit_price;
    OrderedItem = ordered_item;
    Quantity = quantity;
  }

  association _Parent { with draft; }

}

 
```


-----------------------


7. Save your changes. 

8. Generate the draft tables `Z###CART_D` using the quick fix by clicking on the table name and selecting `Ctrl+1` and select **Create draft table `Z###CART_D` for entity `Z###R_CART`** from the context menue.

   ![create root draft table](./images/02_50_generate_draft_root_table.png)  

   ![create root draft table](./images/02_52_create_new_draft_table.png) 

9. Activate the draft table `Z###CART_D`.
   
   ![create root draft table](./images/02_54_create_new_draft_table.png)

10. Generate the draft table `Z###ITEM_D` using the quick fix by clicking on the table name and selecting `Ctrl+1`  and select **Create draft table `Z###ITEM_D` for entity `Z###R_ITEM`** from the context menue.

    ![create child draft table](./images/02_80_generate_draft_child_table.png) 

10. Activate the draft table `Z###ITEM_D`.

11. Save and activate the behavior defintion `Z###R_Cart`.

12. Generate behavior definition class.

    - Choose the name of the behavior definition class `Z###BP_R_CART` in the behavior definition.
    - Press `Ctrl+1` and choose **Create behavior definition class `Z###BP_R_CART`** from the context menu.

     

      ![create behavior implementation class](./images/02_90_generate_bil.png) 

9. Activate the class `z###bp_r_cart`.   

> ‚ÑπÔ∏è The service is not yet CRUD enabled because the respective actions and operations have not been published via the behavior projection. 
> This will be done in the following exercise step **Exercise 3.8. - Create a behavior projection**

</details>

## Coding explained (optional)

In the following section we explain the code changes that have been applied in the code snippet that has been provided above. 

You can proceed with the next exercise step **Exercise 3.8. - Create a behavior projection** or have more closer look at the coding of the behavior definition ![bdef icon](./images/ADT_bdef.png) `Z###R_CART`.

<details>
<summary>Expand for code explanations</summary>  

#### Add draft support to the header section

In the haeader section the statement 
`with draft;`
was added to the BDEF.

so that it reads

<pre>
managed implementation in class zbp_###r_cart unique;
strict ( 2 );
with draft;
</pre>


#### Maintain behavior for the Cart entity

1. Make additional fields readonly in Cart

```ABAP
  field ( readonly )
   LocalCreatedBy,
   LocalCreatedAt,
   LocalLastChangedBy,
   LocalLastChangedAt,
   LastChangedAt;
```

2. Specify the field `OrderUuid` for numbering

```ABAP
  field ( numbering : managed )
   OrderUuid;
```

3. Add the mapping for the persistent table `Z###CART000`  

```ABAP
  mapping for Z###CART000 
  {
    OrderUuid = order_uuid;
    Currency = currency;
    Notes = notes;
    OrderID = order_id;
    TotalPrice = total_price;
    RequestedDeliveryDate = requested_delivery_date;
    LocalCreatedBy = local_created_by;
    LocalCreatedAt = local_created_at;
    LocalLastChangedBy = local_last_changed_by;
    LocalLastChangedAt = local_last_changed_at;
    LastChangedAt = last_changed_at;
  }
```

4. The association statement has to be draft enabled


```ABAP
association _Items { create; with draft; }
```

5. Within the behavior definition of the root entity the draft specific actions have been added

```ABAP
// insert
  draft action Activate optimized;
  draft action Discard;
  draft action Edit;
  draft action Resume;
  draft determine action Prepare;
```

6. Within the root entity we have to specifiy certain fields as the `etag master`, the `lock master` and as the `total etag`.   
In addition we have to specify the root entity as the `authorization master`. 

```ABAP
etag master LocalLastChangedAt
lock master total etag LastChangedAt
authorization master ( global )
```


#### Maintain behavior for the Item entity

1. In the child entity we just have to make the field that stores the UUID based key of the parent entity `Cart` read-only.

```ABAP
  field ( readonly )
   ParentUuid;
```  

2. In addition we have to specify that the UUID based key field `ItemUuid` of the child entity `Item`  is also used for managed numbering.   

```ABAP
  field ( numbering : managed )
   ItemUuid;
```

3. Finally we also have to add a mapping for the persistent table `Z###ITEM000`

```ABAP
  mapping for Z###ITEM000 
  {
    ItemUuid = Item_uuid;
    ParentUuid = parent_uuid;
    Currency = currency;
    ItemID = item_id;
    ItemPrice = item_price;
    ItemUnitPrice = item_unit_price;
    OrderedItem = ordered_item;
    Quantity = quantity;
  }
```

4. The association statement has to be draft enabled


```ABAP
association _Parent { with draft; }
```  

</details>

## 3.8 - Create a behavior projection 

We finally have to add a behavior projection, so that the CRUD functionalities that we have just added to the behavior definition are also exposed by our service and can hence be used by our Fiori Elements UI.  

<details>
<summary>Click to expand</summary>

1. Right click on the CDS projection view `Z###C_CartProjection`. 
2. From the context menu select **New Behavior Definition**  

   ![create_bdef](./images/03_010_add_bdef_projection.png)

3. In the following screen simply press **Next** 
 
   ![create_bdef](./images/03_020_add_bdef_projection.png)

4. In the **Select Transport Request** screen press **Finish**   

5. Replace the coding with the following code   

```ABAP 
projection;
strict ( 2 );
use draft;
use side effects;

define behavior for Z###C_CartProjection alias Cart
use etag
{
  use create;
  use update;
  use delete;

  use action Activate;
  use action Discard;
  use action Edit;
  use action Resume;
  use action Prepare;

  use association _Items { create; with draft; }
}

define behavior for Z###C_ItemProjection alias Item
use etag
{
  use update;
  use delete;

  use association _Parent { with draft; }
}
```


6. Replace the placeholder `###` with your groupID.

7. Save and activate your changes.  

</details>

## 3.9 Test the transactional behavior of the RAP business object

We can now again test the application using the SAP Fiori Elements Preview to check the transactional behavior.

<details>
<summary>Click to expand</summary>

1. Open the service binding `Z###UI_CARTSERVICE_O4`.
2. Double click on the entity set `CartProjection` 
3. Use the **Create** button to create a new Cart entity.

You will notice that basic operations such as **create**, **update** and **delete** (CRUDQ) work fine. However there is no business logic that has been added yet.

</details>

## 3.10 - Define determinations 

In the previous exercise, you have enhanced the base business object data model as well as the projected business object data model and its metadata extension.

In the present exercise, you will define and implement the determination `calculateOrderID` in the behavior definition for the `Cart` entity.   

The determination `calculateOrderID` will be used to automatically calculate and set a sematic key for the field `orderID`.

You will use the Entity Manipulation Language (EML) to implement the transactional behavior of the _Cart_ business object. 

<details>
<summary>Click to expand</summary>

In the following you will define the determination  **`calculateOrderID`** in the behavior definition of the _Cart_ entity.

The determination `calculateOrderID` will be used to calculate the sematic key field `OrderId` when the data is saved.

1. Go to the behavior definiton of the _Cart_ business object entity ![inline](./images/ADT_bdef.png) `ZZ24R_Cart` using ADT and insert the following statements after the statement **`delete;`** as shown on the screenshot below: 

   ```ABAP 
        determination calculateOrderID on save { create; }  

        field ( readonly )
        OrderID; 
   ```     

   > **Short explanation**:  
   > The statement specifies the name of the new determination **`calculateOrderID`**.   
   > The determination **`calculateOrderID`** is configured for `on save` and is thus run when the data is initially saved. (When the **Create** button is pressed.)   
   > Since the field `OrderID` is now being calculated automatically by the aforementioned determination we will make the field `OrderID` readonly as well.   

   ![add determination](./images/10_000_add_determination.png)  

2. Save ![inline](./images/ADT_save.png) and activate ![inline](./images/ADT_activate.png) the changes.

3. Now, declare the required method in behavior implementation class with a ADT Quick Fix.
  
   Set the cursor on the determination name **`calculateOrderID`** and press **Ctrl+1** to open the **Quick Assist** view and select the entry _`Add  missing method of entity zr_AD163U### in local handler class lhc_cart ...`_ in the popup as shown in the screen shot above.   

   As result a `FOR DETERMINE` method called **`calculateOrderID`**  will be added to the local handler class **`lhc_cart`** of the behavior pool of the _Cart_ business object entity ![class icon](./images/ADT_class.png) **`Z###BP_R_CART`**.
    

4. Save ![inline](./images/ADT_save.png) and activate ![inline](./images/ADT_activate.png) the changes in the local handler class **`lhc_cart`**.  

You are now done already with the definition of your determination.

</details>

## 3.11 - Implement the determination using Joule üíé

You will now implement the logic of the defined determination in the behavior pool. 

<details>
<summary>Click to expand</summary>

1. First check the interface of the method **`calculateOrderID`** in the declaration part of the local handler class `lhc_cart`. 

   For that, set the cursor on the method name, **`calculateOrderID`**, press **F2** to open the **ABAP Element Info** view, and examine the full method interface. 
   
   ![Determination signature](./images/11_show_method_signature.png)  

   **Short explanation**:  
   - The addition **`FOR DETERMINE`** indicates that the method provides the implementation of a determination and the addition **`ON SAVE`** indicates the specified trigger time.
   - `IMPORTING`parameter **`keys`** - is an internal table containing the keys of the instances for which the determination will be executed   
   - Implicit **`CHANGING`** parameter **`reported`** - used to return messages in case of failure   


1. Now implement the method **`calculateOrderID`** in the implementation part of the local handler class. Place the cursor behind the statement `METHOD calculateOrderID.` and press **Ctrl+1** to start the quick assistant **Predict RAP business logic**.

   ![Predict RAP business logic](./images/11_010_predict_rap_business_logic_determination.png) 

2. Select the **Predict RAP business logic** entry and enter the following prompt `Calculate a semantic key using the number of entries in table Z###CART` in the dialogue box of the instant action and press **Run**.
   
   ![Predict RAP business logic](./images/11_020_predict_rap_business_logic_determination.png) 

3. Either choose (and correct if needed) the suggested code or take the following code snippet below for your convenience:   

   ![Predict RAP business logic](./images/11_030_predict_rap_business_logic_determination.png) 

```ABAP    

  METHOD calculateOrderID.
  
  DATA: lv_count        TYPE i,
          lv_semantic_key TYPE string.

    " Count the number of entries in the table 
    SELECT COUNT(*) FROM Z###Cart INTO @lv_count.

    " Calculate the semantic key based on the count
    lv_semantic_key = |{ lv_count + 1 }|.

    " Read the entities to be updated
    READ ENTITIES OF Z###R_Cart IN LOCAL MODE
      ENTITY Cart
        FIELDS ( OrderID )
        WITH CORRESPONDING #( keys )
      RESULT DATA(entities).

    " Update the OrderID with the calculated semantic key
    LOOP AT entities INTO DATA(entity).
      MODIFY ENTITIES OF Z###R_Cart IN LOCAL MODE
        ENTITY Cart
          UPDATE FIELDS ( OrderID )
          WITH VALUE #(
            ( %tky = entity-%tky
              OrderID = lv_semantic_key )
          ).      
    ENDLOOP.
  
  
  ENDMETHOD.

```
</details>  

## 3.12 - Define validations

In the previous exercise, you have defined and implemented a determination that is run during the creation of new instances of the BO entity _Cart_. 

Since the content can be invalid (e.g. the date that has been selected as a delivery date lies in the past) we would like to check the data quality upfront.   

<details>
<summary>Click to expand</summary>

In the present exercise, you're going to define and implement a validation for the field `RequestDeliveryDate` in the entity `Cart` to check the following:

|Entity | Validation    | Purpose |
| -------- | -------- | ------- |
| Cart | `validateRequestDeliveryDate` | The value for the field `RequestDeliveryDate` shall not be initial and shall not lie in the past.     |

This validation (as all validations) is only performed in the back-end (not on the UI) and is triggered independently of the caller, i.e. Fiori UIs or EML APIs.


<!--
> ‚Ñπ **Frontend validation & Backend validations**
> Validations are used to ensure the data consistency.
> As the name suggests, **frontend validations** are performed on the UI. They are used to improve the user experience by providing faster feedback and avoiding unnecessary roundtrips. In the RAP context, front-end validations are defined using CDS annotation or UI logic.  
> On the other hand, **backend validations** are performed on the back-end. They are defined in the BO behavior definitons and implemented in the respective behavior pools.
> Frontend validations can be easily bypassed - e.g. by using EML APIs in the RAP context. Therefore, **backend validations are a MUST** to ensure the data consistency.

### About Validations

A validation is an optional part of the business object behavior that checks the consistency of business object instances based on trigger conditions.

A validation is implicitly invoked by the business object‚Äôs framework if the trigger condition of the validation is fulfilled. Trigger conditions can be `MODIFY` operations and modified fields. The trigger condition is evaluated at the trigger time, a predefined point during the BO runtime. An invoked validation can reject inconsistent instance data from being saved by passing the keys of failed instances to the corresponding table in the `FAILED` structure. Additionally, a validation can return messages to the consumer by passing them to the corresponding table in the `REPORTED` structure.

> **Further reading**: [Validations](https://help.sap.com/viewer/923180ddb98240829d935862025004d6/Cloud/en-US/171e26c36cca42699976887b4c8a83bf.html)

-->

  
1. Open your behavior definition **`Z###R_Cart`** using ADT.    

2. Because empty values will not be accepted for the field **`RequestDeliveryDate`**, specify it as a _mandatory_ field by adding the following code snippet at the top of the behavior definition of the `Cart` entity as shown on the screenshot below.

```ABAP  
  // mark mandatory fields
  field ( mandatory )
  RequestDeliveryDate;
```    

   Your source code should look like this:   

   <img src="images/12_010_mandatory_fields_cart.png" alt="mandatory fields bdef" width="50%">     

3. Define the validation **`validateRequestDeliveryDate`**. For that, add the following code snippet in the behavior definition of the `Cart` entity right before the draft actions as shown on the screenshot below.

```ABAP      
      validation validateRequestDeliveryDate on save { create; field RequestDeliveryDate; }
```   
 
4. In order to have draft instances being checked by validations before they become active, they have to be specified for the **`draft determine action prepare`** in the behavior definition.
  
   Replace the code line **`draft determine action Prepare;`** with the following code snippet as shown on the screenshot below

```ABAP
    //draft determine action Prepare;
    draft determine action Prepare
    {     
     validation validateRequestDeliveryDate;
    }
```

   Your source code should look like this: 

   <img src="images/12_030_determine_action.png" alt="validations bdef" width="50%">  

   **Short explanation**:
   - Validations are always invoked during the save and specified with the keyword `on save`.
 
   - `validateRequestDeliveryDate` is a validation with trigger operation `create` and trigger field `RequestDeliveryDate`   
    

   **‚Ñπ Hint**:
   > In case a validation should be invoked at every change of the BO entity instance, then the trigger conditions `create`and `update`
   > must be specified: e.g. `validation validateRequestDeliveryDate on save { create; update; }`

5. Save ![inline](./images/ADT_save.png) and activate ![inline](./images/ADT_activate.png) the changes.

6. Add the appropriate **`FOR VALIDATE ON SAVE`** methods to the local handler classes of the behavior pool of the _Cart_ BO entity via quick fix.  

   For that, set the cursor on one of the validation name `validateRequestDeliveryDate`and press **Ctrl+1** to open the **Quick Assist** view and select the entry **`Add method for validation validaterequestdeliverydate of entity z###r_cart...`**

   ![quick fix validations](./images/12_040_add_methods_for_validations.png)  
   
   As a result, the **`FOR VALIDATE ON SAVE`** method **`validateRequestDeliveryDate`** will be added to the local handler classes `lhc_cart` of the behavior pool ![inline](./images/ADT_class.png)`z###bp_r_cart` of the _Cart_ BO entity.

7. Save ![inline](./images/ADT_save.png) and activate ![inline](./images/ADT_activate.png) the changes.

> Hint:  
> If you get an error message in the behavior implementation `The entity "ZR_CART###" does not have a validation "VALIDATEREQUESTDELIVERYDATE".` try to activate the behavior definition once again.  

</details>

## 3.13 - Implement the validations using Joule üíé   

In this exercise we will implement the previously created validation.

<details>
<summary>Click to expand</summary>
 

1. First, check the interface of the new method in the declaration part of the local handler class `lhc_cart` of the behavior pool of the _Cart_ BO entity ![class icon](./images/ADT_class.png)**`z###bp_r_cart`**.

   For that, set the cursor on the method name, e.g. **`validateRequestDeliveryDate`**, press **F2** to open the **ABAP Element Info** view, and examine the full method interface.

   ![examine method interface f2](./images/13_010_validation_signature.png) 

   **Short explanation**:  
   - The addition **`FOR VALIDATE ON SAVE`** indicates that the method provides the implementation of a validation executed on save. Validations are always executed on save.
   - Method signature for the validation method:
     - `IMPORTING`parameter **`keys`** - an internal table containing the keys of the instances on which the validation should be performed.
     - Implicit `CHANGING` parameters (aka _implicit response parameters_):  
       - **`failed`**   - table with information for identifying the data set where an error occurred
       - **`reported`** - table with data for instance-specific messages

   You can go ahead and implement the validation method.

2. Now implement the newly created method in the implementation part of the class.
  
    The logic consists of the following main steps:
    1. Read the ShoppingCart instance(s) of the transferred keys (**`keys`**) using the EML statement **`READ ENTITIES`**.
    2. The addition **`FIELDS`** is used to specify the fields to be read. E.g. only **`RequestDeliveryDate`** is relevant for the  validation `validateRequestDeliveryDate`.  
       The addition `ALL FIELDS` can be used to read all fields.
    3. The addition **`IN LOCAL MODE`** is used to exclude feature controls and authorization checks.
    4. Check if the value of the field `RequestDeliveryDate` is either initial or lies in the past.  
    5. Prepare/raise messages for all transferred _Cart_ instances with initial and or non valid value of `RequestDeliveryDate` and set the changing parameter **`reported`**



3. Now implement the method **`validateRequestDeliveryDate`** in the implementation part of the local handler class. Place the cursor behind the statement `METHOD validateRequestDeliveryDate.` and press **Ctrl+1** to start the quick assistant.

4. In the popup select **Predict RAP business logic**.  

   ![predict rap business logic validation](./images/13_020_validation_ai_implementation.png)

5. Enter the following prompt:  
   **`Check that the field is not initial and that the date entered in the field is in the future. Do not use the outdated sy-datum statement.`**   
   in the dialogue box of the instant action and press **Run**.    

6. Check that the generated code looks like the following. 

   > ‚ÑπÔ∏è Hint:
   > It is important that the code contains an `APPEND` statement that clears the state area within the `loop`statement, such as 
     ```ABAP
         APPEND  VALUE #(
          %tky        = entity-%tky
          %state_area = 'Validation-RequestDeliveryDate'
         ) TO reported-Item.
     ```  
   > And the state area should have a unique value, so change (if necessary) the value `validation` to something like `Validation-RequestDeliveryDate`.    

   ![predict rap business logic validation](./images/13_030_validation_ai_implementation.png)

   A working implementation looks like follows:  

 ```ABAP
   METHOD validateRequestDeliveryDate.

    READ ENTITIES OF z###r_cart IN LOCAL MODE
      ENTITY Cart
        FIELDS ( RequestDeliveryDate )
        WITH CORRESPONDING #( keys )
      RESULT DATA(entities).

    DATA(current_date) = cl_abap_context_info=>get_system_date( ).

    LOOP AT entities INTO DATA(entity).
      APPEND VALUE #(  %tky               = entity-%tky
                       %state_area        = 'Validation-RequestDeliveryDate'
                     ) TO reported-cart.
      IF entity-RequestDeliveryDate IS INITIAL OR entity-RequestDeliveryDate <= current_date.
        APPEND VALUE #( %tky = entity-%tky ) TO failed-Cart.
        APPEND VALUE #(
            %tky        = entity-%tky
            %state_area = 'Validation-RequestDeliveryDate'
            %msg        = new_message_with_text(
              text     = 'RequestDeliveryDate must be in the future and not initial.'
              severity = if_abap_behv_message=>severity-error
            )
        ) TO reported-Cart.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

 ```

</details>

## 3.14 - Preview and Test the enhanced Online Shop App

> Now the SAP Fiori elements app can be tested.    

You can either refresh your application in the browser using **F5** if the browser is still open - or go to your service binding **`ZUI_AD163U###_O4`** and start the Fiori elements App preview for the **`CartProjection`** entity set.

<details>
<summary>Click to expand</summary>

1. Click **Create** to create a new entry.

2. Select a requested delivery date **that lies in the past**. 

   The draft will be updated.

3. Now click **Create**. You should get following error messages displayed:  
   **Requested delivery date is in the past** .

    ![Preview](./images/14_test_validation.png)

</details>

## Summary 

Now that you have... 

- defined a determination and a validations in the behavior definition, 
- implemented them in the behavior pool, and
- previewed and tested the enhanced Fiori elements app,

you can continue with the next exercise.


## Summary & Next Exercise

**[Exercise 4: Create, preview and adapt a SAP Fiori elements application](../ex4/README.md)**.


[^Top of page](#)
